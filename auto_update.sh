#!/bin/bash

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ –∏ –ø—É—à –≤ Git

echo "üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–õ–ï–ô–õ–ò–°–¢–û–í"
echo "======================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python 3 –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

if ! command -v git &> /dev/null; then
    echo "‚ùå Git –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
python3 -c "import requests" 2>/dev/null || {
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º requests..."
    pip3 install requests
}

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–∏—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
echo "üíæ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø..."
BACKUP_DIR="backups/$(date '+%Y%m%d_%H%M%S')"
mkdir -p "$BACKUP_DIR"
cp -r categories/ "$BACKUP_DIR/" 2>/dev/null || echo "‚ö†Ô∏è –ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –±—ç–∫–∞–ø–∞"

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–µ—Ä
echo "üîç –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–µ—Ä –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤..."
python3 scripts/playlist_parser.py

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤"
    exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–ª–∏—Å—Ç
echo "üìù –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–ª–∏—Å—Ç..."
python3 scripts/create_televizo_playlist.py

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
git add .
CHANGES=$(git diff --cached --name-only)

if [ -z "$CHANGES" ]; then
    echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
    exit 0
fi

echo "üìã –ù–∞–π–¥–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö:"
echo "$CHANGES"

# –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç
TIMESTAMP=$(date '+%d.%m.%Y %H:%M')
COMMIT_MSG="üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ ($TIMESTAMP)

–û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
$(echo "$CHANGES" | grep "categories/" | sed 's/categories\///g' | sed 's/\.m3u//g' | sort | uniq | head -10)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø–∞—Ä—Å–µ—Ä–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤"

echo "üíæ –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç..."
git commit -m "$COMMIT_MSG"

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–∏—Ç–∞"
    exit 1
fi

# –ü—É—à–∏–º –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
echo "üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
git push origin main

if [ $? -eq 0 ]; then
    echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    echo ""
    echo "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø:"
    echo "   –í—Ä–µ–º—è: $TIMESTAMP"
    echo "   –ò–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: $(echo "$CHANGES" | wc -l)"
    echo "   –ö–∞—Ç–µ–≥–æ—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–æ: $(echo "$CHANGES" | grep "categories/" | wc -l)"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    echo ""
    echo "üìÅ –†–ê–ó–ú–ï–†–´ –ö–ê–¢–ï–ì–û–†–ò–ô:"
    for category in categories/*.m3u; do
        if [ -f "$category" ]; then
            CHANNELS=$(grep -c "^http" "$category" 2>/dev/null || echo 0)
            BASENAME=$(basename "$category" .m3u)
            printf "   %-20s %s –∫–∞–Ω–∞–ª–æ–≤\n" "$BASENAME:" "$CHANNELS"
        fi
    done
    
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
    echo "üí° –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Git credentials"
    exit 1
fi

echo ""
echo "üéâ –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
