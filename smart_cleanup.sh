#!/bin/bash

# –£–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—á–∏—Å—Ç–∫–∏ IPTV –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π:
# 1. –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑ –¥–æ–Ω–æ—Ä–æ–≤ (—Å–≤–µ–∂–∏–µ —Å—Å—ã–ª–∫–∏)
# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï –∫–∞–Ω–∞–ª—ã (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ)
# 3. –£–¥–∞–ª—è–µ–º –Ω–µ—Ä–∞–±–æ—á–∏–µ
# 4. –ê–≤—Ç–æ–ø—É—à –≤ Git

echo "ü§ñ –£–ú–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –û–ß–ò–°–¢–ö–ò IPTV –ü–õ–ï–ô–õ–ò–°–¢–û–í"
echo "========================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."

if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python 3 –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

if ! command -v git &> /dev/null; then
    echo "‚ùå Git –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –≤–∏–¥–µ–æ
TOOLS_COUNT=0
for tool in ffprobe vlc mpv curl; do
    if command -v $tool &> /dev/null; then
        echo "‚úÖ $tool –¥–æ—Å—Ç—É–ø–µ–Ω"
        TOOLS_COUNT=$((TOOLS_COUNT + 1))
    fi
done

if [ $TOOLS_COUNT -eq 0 ]; then
    echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–µ–æ!"
    echo "üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: ffmpeg, vlc, mpv –∏–ª–∏ curl"
    exit 1
fi

echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ $TOOLS_COUNT –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–µ–æ"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
python3 -c "import requests, aiohttp" 2>/dev/null || {
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pip3 install requests aiohttp
}

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–ø–∫–∏
mkdir -p reports backups/full_backups

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
DRY_RUN=false
CONFIG="donors_config.json"

# –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --config)
            CONFIG="$2"
            shift 2
            ;;
        --help|-h)
            echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–û–ü–¶–ò–ò]"
            echo ""
            echo "–£–º–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π:"
            echo "  1. üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –¥–æ–Ω–æ—Ä—Å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"
            echo "  2. üé¨ –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–≤"
            echo "  3. üßπ –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ—Ä–∞–±–æ—á–∏—Ö –∫–∞–Ω–∞–ª–æ–≤"
            echo "  4. üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Git push"
            echo ""
            echo "–û–ø—Ü–∏–∏:"
            echo "  --dry-run        –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
            echo "  --config FILE    –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: donors_config.json)"
            echo "  --help, -h       –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
            echo ""
            echo "–ü—Ä–∏–º–µ—Ä—ã:"
            echo "  $0                    # –ü–æ–ª–Ω–∞—è —É–º–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞"
            echo "  $0 --dry-run          # –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫"
            exit 0
            ;;
        *)
            echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø—Ü–∏—è: $1"
            echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏"
            exit 1
            ;;
    esac
done

echo ""
echo "üéØ –ü–ê–†–ê–ú–ï–¢–†–´ –ó–ê–ü–£–°–ö–ê:"
echo "   –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: $CONFIG"
echo "   –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: $([ "$DRY_RUN" = true ] && echo "–î–ê" || echo "–ù–ï–¢")"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Git —Å—Ç–∞—Ç—É—Å
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ Git —Å—Ç–∞—Ç—É—Å–∞..."
git status --porcelain > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "‚ùå –ù–µ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏–ª–∏ –æ—à–∏–±–∫–∞ Git"
    exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
UNCOMMITTED=$(git status --porcelain | wc -l)
if [ $UNCOMMITTED -gt 0 ]; then
    echo "‚ö†Ô∏è –ï—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: $UNCOMMITTED —Ñ–∞–π–ª–æ–≤"
    echo "üí° –û–Ω–∏ –±—É–¥—É—Ç –≤–∫–ª—é—á–µ–Ω—ã –≤ –∏—Ç–æ–≥–æ–≤—ã–π –∫–æ–º–º–∏—Ç"
fi

echo ""
echo "üöÄ –ó–ê–ü–£–°–ö –£–ú–ù–û–ô –û–ß–ò–°–¢–ö–ò..."
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã
echo "üìã –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´:"
echo "   1Ô∏è‚É£ –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π–ª–∏—Å—Ç—ã –∏–∑ –¥–æ–Ω–æ—Ä—Å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"
echo "   2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï –∫–∞–Ω–∞–ª—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å"
echo "   3Ô∏è‚É£ –£–¥–∞–ª—è–µ–º –Ω–µ—Ä–∞–±–æ—á–∏–µ –∫–∞–Ω–∞–ª—ã"
echo "   4Ô∏è‚É£ –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–ª–∏—Å—Ç"
echo "   5Ô∏è‚É£ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–º–º–∏—Ç–∏–º –∏ –ø—É—à–∏–º –≤ Git"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º —É–º–Ω—É—é —Å–∏—Å—Ç–µ–º—É
if [ "$DRY_RUN" = true ]; then
    python3 scripts/smart_cleanup_system.py --config "$CONFIG" --dry-run
else
    python3 scripts/smart_cleanup_system.py --config "$CONFIG"
fi

CLEANUP_EXIT_CODE=$?

if [ $CLEANUP_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "‚ùå –û–®–ò–ë–ö–ê –ü–†–ò –í–´–ü–û–õ–ù–ï–ù–ò–ò –£–ú–ù–û–ô –û–ß–ò–°–¢–ö–ò"
    echo ""
    echo "üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "   ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–Ω–æ—Ä—Å–∫–∏—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤"
    echo "   ‚Ä¢ –û—à–∏–±–∫–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–≤"
    echo "   ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å Git (–Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ push)"
    echo "   ‚Ä¢ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ"
    echo ""
    echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
    exit 1
fi

echo ""
echo "üéâ –£–ú–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!"
echo ""
echo "‚ú® –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û:"
echo "   üîÑ –ü–ª–µ–π–ª–∏—Å—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Å–≤–µ–∂–∏—Ö –¥–æ–Ω–æ—Ä—Å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"
echo "   üé¨ –í—Å–µ –∫–∞–Ω–∞–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å"
echo "   üßπ –ù–µ—Ä–∞–±–æ—á–∏–µ –∫–∞–Ω–∞–ª—ã —É–¥–∞–ª–µ–Ω—ã"
echo "   üìù –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–ª–∏—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω"
echo "   üöÄ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Git"
echo "   üíæ –°–æ–∑–¥–∞–Ω—ã –ø–æ–ª–Ω—ã–µ –±—ç–∫–∞–ø—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
echo ""
echo "üéØ –†–ï–ó–£–õ–¨–¢–ê–¢: –í–∞—à–∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ –∫–∞–Ω–∞–ª—ã"
echo "              —Å —Å–∞–º—ã–º–∏ —Å–≤–µ–∂–∏–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –∏–∑ –¥–æ–Ω–æ—Ä—Å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤!"
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π Git —Å—Ç–∞—Ç—É—Å
echo "üìä –§–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ê–¢–£–°:"
TOTAL_CHANNELS=0
for category in categories/*.m3u; do
    if [ -f "$category" ]; then
        CHANNELS=$(grep -c "^http" "$category" 2>/dev/null || echo 0)
        TOTAL_CHANNELS=$((TOTAL_CHANNELS + CHANNELS))
    fi
done

echo "   üì∫ –í—Å–µ–≥–æ —Ä–∞–±–æ—á–∏—Ö –∫–∞–Ω–∞–ª–æ–≤: $TOTAL_CHANNELS"
echo "   üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏–π: $(ls categories/*.m3u 2>/dev/null | wc -l)"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç
echo ""
echo "üìã –ü–û–°–õ–ï–î–ù–ò–ô –ö–û–ú–ú–ò–¢:"
git log --oneline -1 | sed 's/^/   /'

echo ""
echo "üéä –ì–æ—Ç–æ–≤–æ! –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ IPTV –ø–ª–µ–π–ª–∏—Å—Ç–∞–º–∏!"
