#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-–∞–¥–º–∏–Ω–∫–∏ IPTV

echo "üöÄ –ó–∞–ø—É—Å–∫ –≤–µ–±-–∞–¥–º–∏–Ω–∫–∏ IPTV"
echo "=========================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python 3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.7+"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if ! python3 -c "import flask" 2>/dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pip3 install -r requirements.txt
    if [ $? -ne 0 ]; then
        echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ: pip3 install flask aiohttp"
        exit 1
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º ffmpeg (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
if command -v ffprobe &> /dev/null; then
    echo "‚úÖ ffprobe –Ω–∞–π–¥–µ–Ω - –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç–æ–∫–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–∞"
else
    echo "‚ö†Ô∏è ffprobe –Ω–µ –Ω–∞–π–¥–µ–Ω - —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç–æ–∫–æ–≤"
    echo "–î–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install ffmpeg"
fi

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–ø–∫–∏
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –ø–∞–ø–æ–∫..."
mkdir -p reports
mkdir -p backups

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞
if [ ! -f "playlists/televizo_main.m3u" ]; then
    echo "‚ö†Ô∏è –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–ª–∏—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ñ–∞–π–ª playlists/televizo_main.m3u —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º IP –∞–¥—Ä–µ—Å
LOCAL_IP=$(ifconfig | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}' | head -1)

echo ""
echo "üåê –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞..."
echo "========================"
echo "üìä –ê–¥—Ä–µ—Å–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:"
echo "   –õ–æ–∫–∞–ª—å–Ω–æ:    http://localhost:5000"
if [ -n "$LOCAL_IP" ]; then
    echo "   –í —Å–µ—Ç–∏:      http://$LOCAL_IP:5000"
fi
echo ""
echo "üîß –§—É–Ω–∫—Ü–∏–∏:"
echo "   ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤"
echo "   ‚úÖ –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏"
echo "   ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç–æ–∫–æ–≤"
echo "   ‚úÖ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ GitHub"
echo ""
echo "‚èπÔ∏è –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É web –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
cd web

# –ó–∞–ø—É—Å–∫ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
python3 app.py 2>&1 | while IFS= read -r line; do
    # –î–æ–±–∞–≤–ª—è–µ–º timestamp –∫ –ª–æ–≥–∞–º
    echo "[$(date '+%H:%M:%S')] $line"
done
