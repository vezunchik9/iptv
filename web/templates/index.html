<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∫ IPTV –ê–¥–º–∏–Ω–∫–∞ - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞–º–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        .status-working { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-unknown { color: #6c757d; }
        .channel-disabled { opacity: 0.5; }
        .bulk-actions { 
            position: sticky; 
            top: 0; 
            background: white; 
            z-index: 1000; 
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        .logo-preview {
            max-width: 40px;
            max-height: 30px;
            object-fit: contain;
        }
        .channel-name {
            font-weight: 500;
        }
        .category-badge {
            font-size: 0.8em;
        }
        .actions-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-tv"></i> IPTV –ê–¥–º–∏–Ω–∫–∞
            </span>
            <div class="d-flex">
                <span class="navbar-text me-3">
                    <i class="bi bi-broadcast"></i> <span id="total-channels">{{ channels|length }}</span> –∫–∞–Ω–∞–ª–æ–≤
                </span>
                <button class="btn btn-success btn-sm" onclick="saveAll()">
                    <i class="bi bi-cloud-upload"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–ø—É—à–∏—Ç—å
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">üîç –ü–æ–∏—Å–∫</label>
                <input type="text" class="form-control" id="search-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è...">
            </div>
            <div class="col-md-3">
                <label class="form-label">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-select" id="category-filter">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">‚öôÔ∏è –°—Ç–∞—Ç—É—Å</label>
                <select class="form-select" id="status-filter">
                    <option value="">–í—Å–µ –∫–∞–Ω–∞–ª—ã</option>
                    <option value="enabled">–í–∫–ª—é—á–µ–Ω–Ω—ã–µ</option>
                    <option value="disabled">–û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ</option>
                    <option value="working">–†–∞–±–æ—Ç–∞—é—â–∏–µ</option>
                    <option value="error">–° –æ—à–∏–±–∫–∞–º–∏</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary me-2" onclick="checkAllStreams()">
                    <i class="bi bi-play-circle"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ç–æ–∫–∏
                </button>
                <button class="btn btn-outline-secondary" onclick="refreshTable()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π -->
        <div class="bulk-actions" id="bulk-actions" style="display: none;">
            <div class="row">
                <div class="col-md-12">
                    <div class="bg-light p-3 rounded">
                        <strong><span id="selected-count">0</span> –∫–∞–Ω–∞–ª–æ–≤ –≤—ã–±—Ä–∞–Ω–æ</strong>
                        <div class="btn-group ms-3" role="group">
                            <button class="btn btn-success btn-sm" onclick="bulkAction('enable')">
                                <i class="bi bi-check-circle"></i> –í–∫–ª—é—á–∏—Ç—å
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="bulkAction('disable')">
                                <i class="bi bi-x-circle"></i> –û—Ç–∫–ª—é—á–∏—Ç—å
                            </button>
                            <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#groupModal">
                                <i class="bi bi-folder"></i> –ò–∑–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="bulkDelete()">
                                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm ms-3" onclick="clearSelection()">
                            –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–∞–Ω–∞–ª–æ–≤ -->
        <div class="table-container">
            <table class="table table-striped table-hover" id="channels-table">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th width="50px">
                            <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                        </th>
                        <th width="60px">–õ–æ–≥–æ</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th width="80px">–°—Ç–∞—Ç—É—Å</th>
                        <th width="120px">–ü—Ä–æ–≤–µ—Ä–∫–∞</th>
                        <th width="150px">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="channels-tbody">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <input type="hidden" id="edit-channel-id">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</label>
                                <input type="text" class="form-control" id="edit-name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                <select class="form-select" id="edit-group">
                                    {% for category in categories %}
                                    <option value="{{ category }}">{{ category }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">URL –ø–æ—Ç–æ–∫–∞</label>
                            <input type="url" class="form-control" id="edit-url" required>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">–õ–æ–≥–æ—Ç–∏–ø (URL)</label>
                            <input type="url" class="form-control" id="edit-logo">
                        </div>
                        <div class="mt-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="edit-enabled">
                                <label class="form-check-label" for="edit-enabled">
                                    –ö–∞–Ω–∞–ª –≤–∫–ª—é—á–µ–Ω
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="saveChannel()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –≥—Ä—É–ø–ø—ã -->
    <div class="modal fade" id="groupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìÅ –ò–∑–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                    <select class="form-select" id="bulk-group-select">
                        {% for category in categories %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                    <div class="mt-3">
                        <label class="form-label">–ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é:</label>
                        <input type="text" class="form-control" id="new-group-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="changeBulkGroup()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        let channels = [];
        let selectedChannels = new Set();
        let checkingStreams = false;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        $(document).ready(function() {
            loadChannels();
            setupFilters();
        });

        function loadChannels() {
            $.get('/api/channels?per_page=1000', function(data) {
                channels = data.channels;
                updateTable();
                $('#total-channels').text(channels.filter(c => c.enabled).length);
            }).fail(function() {
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤', 'danger');
            });
        }

        function updateTable() {
            const tbody = $('#channels-tbody');
            tbody.empty();
            
            channels.forEach(function(channel) {
                const row = createChannelRow(channel);
                tbody.append(row);
            });
        }

        function createChannelRow(channel) {
            const statusIcon = getStatusIcon(channel);
            const enabledClass = channel.enabled ? '' : 'channel-disabled';
            
            return `
                <tr class="${enabledClass}" data-channel-id="${channel.id}">
                    <td>
                        <input type="checkbox" class="channel-select" 
                               value="${channel.id}" onchange="updateSelection()">
                    </td>
                    <td>
                        ${channel.tvg_logo ? 
                          `<img src="${channel.tvg_logo}" class="logo-preview" 
                                onerror="this.style.display='none'">` : 
                          '<i class="bi bi-image text-muted"></i>'}
                    </td>
                    <td>
                        <div class="channel-name">${channel.name}</div>
                        <small class="text-muted">${channel.tvg_id || '–ë–µ–∑ ID'}</small>
                    </td>
                    <td>
                        <span class="badge bg-secondary category-badge">${channel.group}</span>
                    </td>
                    <td>
                        <span class="badge ${channel.enabled ? 'bg-success' : 'bg-danger'}">
                            ${channel.enabled ? '–í–∫–ª' : '–í—ã–∫–ª'}
                        </span>
                    </td>
                    <td>
                        <span class="stream-status" id="status-${channel.id}">${statusIcon}</span>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary actions-btn" 
                                    onclick="editChannel(${channel.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-info actions-btn" 
                                    onclick="cloneChannel(${channel.id})" title="–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å">
                                <i class="bi bi-files"></i>
                            </button>
                            <button class="btn btn-outline-success actions-btn" 
                                    onclick="testStream(${channel.id})" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ç–æ–∫">
                                <i class="bi bi-play-circle"></i>
                            </button>
                            <button class="btn btn-outline-warning actions-btn" 
                                    onclick="toggleChannel(${channel.id})" title="–í–∫–ª/–í—ã–∫–ª">
                                <i class="bi bi-power"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function getStatusIcon(channel) {
            if (channel.working === null) {
                return '<i class="bi bi-question-circle status-unknown" title="–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω"></i>';
            } else if (channel.working) {
                return '<i class="bi bi-check-circle status-working" title="–†–∞–±–æ—Ç–∞–µ—Ç"></i>';
            } else {
                return '<i class="bi bi-x-circle status-error" title="–û—à–∏–±–∫–∞"></i>';
            }
        }

        function setupFilters() {
            $('#search-input').on('input', filterChannels);
            $('#category-filter').on('change', filterChannels);
            $('#status-filter').on('change', filterChannels);
        }

        function filterChannels() {
            const search = $('#search-input').val().toLowerCase();
            const category = $('#category-filter').val();
            const status = $('#status-filter').val();
            
            $('#channels-tbody tr').each(function() {
                const row = $(this);
                const channelId = row.data('channel-id');
                const channel = channels.find(c => c.id === channelId);
                
                if (!channel) return;
                
                let show = true;
                
                // –§–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞
                if (search && !channel.name.toLowerCase().includes(search) && 
                    !channel.group.toLowerCase().includes(search)) {
                    show = false;
                }
                
                // –§–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                if (category && channel.group !== category) {
                    show = false;
                }
                
                // –§–∏–ª—å—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞
                if (status) {
                    if (status === 'enabled' && !channel.enabled) show = false;
                    if (status === 'disabled' && channel.enabled) show = false;
                    if (status === 'working' && channel.working !== true) show = false;
                    if (status === 'error' && channel.working !== false) show = false;
                }
                
                row.toggle(show);
            });
        }

        function updateSelection() {
            selectedChannels.clear();
            $('.channel-select:checked').each(function() {
                selectedChannels.add(parseInt($(this).val()));
            });
            
            $('#selected-count').text(selectedChannels.size);
            $('#bulk-actions').toggle(selectedChannels.size > 0);
        }

        function toggleSelectAll() {
            const selectAll = $('#select-all').prop('checked');
            $('.channel-select:visible').prop('checked', selectAll);
            updateSelection();
        }

        function clearSelection() {
            $('.channel-select').prop('checked', false);
            $('#select-all').prop('checked', false);
            updateSelection();
        }

        function editChannel(channelId) {
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;
            
            $('#edit-channel-id').val(channel.id);
            $('#edit-name').val(channel.name);
            $('#edit-group').val(channel.group);
            $('#edit-url').val(channel.url);
            $('#edit-logo').val(channel.tvg_logo);
            $('#edit-enabled').prop('checked', channel.enabled);
            
            $('#editModal').modal('show');
        }

        function saveChannel() {
            const channelId = $('#edit-channel-id').val();
            const data = {
                name: $('#edit-name').val(),
                group: $('#edit-group').val(),
                url: $('#edit-url').val(),
                tvg_logo: $('#edit-logo').val(),
                enabled: $('#edit-enabled').prop('checked')
            };
            
            $.ajax({
                url: `/api/channel/${channelId}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        const channel = channels.find(c => c.id == channelId);
                        if (channel) {
                            Object.assign(channel, data);
                        }
                        updateTable();
                        $('#editModal').modal('hide');
                        showAlert('–ö–∞–Ω–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    }
                },
                error: function() {
                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞', 'danger');
                }
            });
        }

        function cloneChannel(channelId) {
            $.post(`/api/channel/${channelId}/clone`, function(response) {
                if (response.success) {
                    channels.push(response.channel);
                    updateTable();
                    showAlert('–ö–∞–Ω–∞–ª –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω', 'success');
                }
            }).fail(function() {
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏', 'danger');
            });
        }

        function toggleChannel(channelId) {
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;
            
            const data = { enabled: !channel.enabled };
            
            $.ajax({
                url: `/api/channel/${channelId}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        channel.enabled = !channel.enabled;
                        updateTable();
                        showAlert(channel.enabled ? '–ö–∞–Ω–∞–ª –≤–∫–ª—é—á–µ–Ω' : '–ö–∞–Ω–∞–ª –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
                    }
                }
            });
        }

        function bulkAction(action) {
            if (selectedChannels.size === 0) return;
            
            const data = {
                action: action,
                channel_ids: Array.from(selectedChannels)
            };
            
            $.ajax({
                url: '/api/bulk-action',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        loadChannels();
                        clearSelection();
                        showAlert('–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'success');
                    }
                }
            });
        }

        function changeBulkGroup() {
            const newGroup = $('#new-group-name').val() || $('#bulk-group-select').val();
            if (!newGroup || selectedChannels.size === 0) return;
            
            const data = {
                action: 'change_group',
                channel_ids: Array.from(selectedChannels),
                new_group: newGroup
            };
            
            $.ajax({
                url: '/api/bulk-action',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        loadChannels();
                        clearSelection();
                        $('#groupModal').modal('hide');
                        showAlert('–ì—Ä—É–ø–ø–∞ –∏–∑–º–µ–Ω–µ–Ω–∞', 'success');
                    }
                }
            });
        }

        function testStream(channelId) {
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;
            
            const statusElement = $(`#status-${channelId}`);
            statusElement.html('<i class="bi bi-arrow-clockwise fa-spin"></i>');
            
            // –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç–æ–∫–∞
            $.ajax({
                url: `/api/check-stream/${channelId}`,
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        Object.assign(channel, response.channel);
                        statusElement.html(getStatusIcon(channel));
                        
                        const result = response.result;
                        let message = `–ü–æ—Ç–æ–∫ ${result.working ? '—Ä–∞–±–æ—Ç–∞–µ—Ç' : '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç'}`;
                        if (result.response_time) {
                            message += ` (${result.response_time}–º—Å)`;
                        }
                        showAlert(message, result.working ? 'success' : 'warning');
                    } else {
                        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ—Ç–æ–∫–∞', 'danger');
                        statusElement.html('<i class="bi bi-x-circle status-error"></i>');
                    }
                },
                error: function() {
                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ—Ç–æ–∫–∞', 'danger');
                    statusElement.html('<i class="bi bi-x-circle status-error"></i>');
                }
            });
        }

        function checkAllStreams() {
            if (checkingStreams) return;
            
            checkingStreams = true;
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            btn.disabled = true;
            
            // –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤
            $.ajax({
                url: '/api/check-all-streams',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    detailed: false,
                    enabled_only: true
                }),
                success: function(response) {
                    if (response.success) {
                        showAlert(response.message, 'success');
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                        const progressInterval = setInterval(() => {
                            loadChannels(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                        }, 2000);
                        
                        // –ß–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        setTimeout(() => {
                            clearInterval(progressInterval);
                            loadChannels();
                            showAlert('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç–æ–∫–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–º–æ—Ç—Ä–∏—Ç–µ –æ—Ç—á–µ—Ç—ã –≤ –ø–∞–ø–∫–µ reports/', 'info');
                        }, 30000);
                        
                    } else {
                        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + response.error, 'danger');
                    }
                },
                error: function() {
                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Ç–æ–∫–æ–≤', 'danger');
                },
                complete: function() {
                    checkingStreams = false;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        }

        function saveAll() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            btn.disabled = true;
            
            $.post('/api/save', function(response) {
                if (response.success) {
                    showAlert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ GitHub!', 'success');
                } else {
                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'danger');
                }
            }).fail(function() {
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'danger');
            }).always(function() {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        function refreshTable() {
            loadChannels();
            showAlert('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'info');
        }

        function showAlert(message, type) {
            const alert = $(`
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append(alert);
            
            setTimeout(() => {
                alert.alert('close');
            }, 5000);
        }
    </script>
</body>
</html>
